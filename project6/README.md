# 协议原理（Markdown 说明）

## 1. 目标与总体思路

该示例实现了一个基于 **DDH（离散对数随机性）假设** 和 **Paillier 加法同态加密** 的 *私有交集求和（Private Intersection-Sum）* 协议。
目标：两方 $P1$ 与 $P2$ 分别持有集合

* $P1$ 有标识符集合 $V=\{v_i\}$，
* $P2$ 有带权对集合 $W=\{(w_j,t_j)\}$。

最终让 $P2$ 恢复交集上权重的和 $S=\sum_{j: w_j\in V} t_j$，同时尽量保护双方的其它信息。实现依赖两类密码原语：**群幂运算（以乘法群 $\mathbb{Z}_p^*$ 为例）** 与 **Paillier 加法同态加密**。

---

## 2. 使用到的密码学原语（高层概述）

* **乘法群 $G=\mathbb{Z}_p^*$**：选大素数 $p$ 和生成元 $g$，在群上用幂运算（例如 $x\mapsto x^k$）作为单向/伪随机变换的工具。基于 DDH 难题，单看 $g^a$ 与 $g^b$ 无法轻易恢复底数或判定关系。
* **哈希到群 $H: U\to G$**：把任意标识符（字符串）映射到群元素，示例里通过 SHA-256 取整模 $p-1$ 然后做 $g^{\text{hash}}\bmod p$。在理想情况下把 $H$ 当作随机预言机处理（避免可预测性）。
* **Paillier 加法同态加密**：生成公私钥对 $(pk,sk)$。加密满足

  $$
  \text{Enc}(m_1)\cdot\text{Enc}(m_2) = \text{Enc}(m_1+m_2)
  $$

  因此可以把若干个权重密文同态相乘得到总和的密文，只有持私钥者能解出总和。

---

## 3. 协议逐轮描述（高层、去代码化）

### Setup（一次性）

* 双方约定群 $G$（素数 $p$、基元 $g$）、哈希函数 $H$。
* $P1$ 选随机私钥 $k_1\in\mathbb{Z}_{p-1}$；$P2$ 选随机私钥 $k_2\in\mathbb{Z}_{p-1}$。
* $P2$ 生成 Paillier 密钥对 $(pk,sk)$，把公钥 $pk$ 发给 $P1$。

> 目的：$k_1,k_2$ 用于对哈希后的标识进行不可逆变换（幂运算），Paillier 用于保护数值权重。

---

### Round 1（P1 → P2）

* $P1$ 对自己每个 id $v$ 计算 $H(v)$（群元素），再取幂得到 $H(v)^{k_1}$，把这些值（打乱顺序）发给 $P2$。

**作用：** 把明文 id 隐藏为群元素的幂，且被 $k_1$ 混淆。

---

### Round 2（P2 → P1）

* 对 $P1$ 发来的每个 $H(v)^{k_1}$，$P2$ 再取幂得到 $H(v)^{k_1 k_2}$，把这些值（打乱）发回给 $P1$。称返回集合为 $Z=\{H(v)^{k_1k_2}\}$。
* 同时，$P2$ 对自己每个对 $(w,t)$：

  * 计算 $H(w)^{k_2}$（把自己的 id 做一次幂变换），
  * 用 Paillier 公钥对权重 $t$ 加密得到 $\text{Enc}(t)$。
* $P2$ 将若干个配对 $(H(w)^{k_2},\; \text{Enc}(t))$（顺序打乱）发给 $P1$。

**作用：** $P2$ 把两类信息都以混淆形式发送，保留用于交集测试与权重保护。

---

### Round 3（P1 → P2）

* $P1$ 对每个收到的 $H(w)^{k_2}$ 再取幂 $k_1$，得到 $H(w)^{k_1k_2}$。
* $P1$ 令交集索引集合为

  $$
  J=\{j\mid H(w_j)^{k_1k_2}\in Z\}
  $$

  即通过比较群元素判断哪些 $w_j$ 与自己某个 $v_i$ 是同一标识符（因为 $H(v)^{k_1k_2}$ 在两边一致）。
* 对于交集内的每个 $j\in J$，$P1$ 把对应的 Paillier 密文 $\text{Enc}(t_j)$ 做同态相乘（等价于同态相加权重），得到 $\text{Enc}\big(\sum_{j\in J} t_j\big)$。
* 为避免可被关联，$P1$ 对最终密文做随机化（Paillier 的重随机化 / 加密 0）并把它发回给 $P2$。

**作用：** $P1$ 根据双重幂的匹配得到交集身份（对 $P1$ 可见），并把对应权重的密文同态求和后随机化，保护单个权重不被识别。

---

### 输出（由 P2 完成）

* $P2$ 用自己的 Paillier 私钥对收到的最终密文解密，得到交集权重和 $S$。

---

## 4. 正确性证明（直观）

* 若某元素是交集元素 $w_j=v_i$，则

  $$
  P1\ \text{计算的}\ H(w_j)^{k_1k_2} = H(v_i)^{k_1k_2}
  $$

  这使得 $P1$ 能通过集合成员关系测试识别交集。
* 同态性保证：

  $$
  \prod_{j\in J}\text{Enc}(t_j) = \text{Enc}\Big(\sum_{j\in J} t_j\Big)
  $$

  因此 $P2$ 解密后得到正确的交集和。

---

## 5. 隐私/安全分析（威胁模型：半诚实/“honest-but-curious”）

**安全假设：**

* 群幂变换在 DDH 难题下是不可逆的，单看 $H(v)^{k_1}$ 不应泄露 $v$。
* Paillier 满足语义安全（IND-CPA），密文隐藏权重。

**实际泄露 / 限制：**

* **P1 会知道交集的具体标识符集合 $J$**（因为它需要知道哪些密文要相加）。这是该协议的设计选择——交集对 P1 是可见的。
* **P2 只得到交集和 $S$**。P2 不直接知道哪些具体的 $v$ 出现在交集中（除非从已知的权重和组合推断出来）。
* **可观察的侧信道/泄露**：交集大小、最终和的大小、Paillier 公钥和某些通信长度都可能被利用做侧信道分析。若标识符字典小（低熵），攻击者可做字典/暴力比对来识别具体 id，故必须对哈希做盐或采用 OPRF 等保护。
* **主动攻击**：示例实现假设双方半诚实；若一方作恶（伪造消息、选择特殊权重或选择性发送），可以通过构造特殊输入来试探对方集合（例如选择许多单位权重、或特殊伪造的群元素）。对抗主动攻击需引入消息认证、零知识证明或更强的 PSI 构造。

---

## 6. 实用注意事项与改进建议

* **参数与安全性**：示例用较小位长（演示用）。生产应使用受信任库、至少 2048-bit（或更高）Paillier 和合适的群大小；或改用椭圆曲线下的高效 OPRF/PSI 协议以减小带宽/计算量。
* **防止字典攻击**：在哈希前与每个 id 加随机盐/秘钥（例如使用 OPRF）或对 id 做高熵编码，避免直接对常见邮箱/用户名暴力匹配。
* **隐私加强**：

  * 如果要让**双方都不知道交集成员**，可以采用更复杂的 PSI 或 PSI-sum 构造（例如基于 OT 的 KKRT、基于布隆过滤器的隐私集合交互、或用安全多方计算/同态运算的混合方案）。
  * 为防止 $P2$ 从总和反推单个权重组合，可用差分隐私或阈值化（只返回当交集大小超过某阈值时的和）。
* **抗主动攻击**：引入消息签名 / MAC、以及对 Paillier 密文操作的零知识证明，确保对方未伪造密文或乱序信息。
* **效率优化**：

  * 群幂运算可用窗口法、批量指数化等优化；
  * Paillier 加密/解密开销大，针对大规模集合考虑分块或使用更高效同态方案；
  * 使用 ECC + OPRF 可以在等安全级别下显著降低数据量与计算量。

---

## 7. 复杂度与通信量（定性）

* **计算量**：主要成本是群幂运算与 Paillier 加解密。总体上约为 $O(|V| + |W|)$ 个指数运算（不同步骤分布于两方）。
* **通信量**：传输若干群元素（每个元素大小约 $|p|$ 位）和若干 Paillier 密文（大小约 $O(|n|^2)$ 位，常是 $2|n|$ 比特左右）。所以通信量随集合大小线性增长，且每个 Paillier 密文明显大于单个群元素。

---

## 8. 小结

该实现把 **“标识隐私”**（通过哈希+双重幂基于 DDH 难题）与 **“权重隐私”**（通过 Paillier 同态加密）结合起来：$P1$ 能识别与自己匹配的 id 并把对应密文同态求和，$P2$ 最终解密得到交集总和。实现简单且直观，适合教学与原型验证；若用于真实环境，需用更强的参数、对抗主动攻击的机制以及对低熵 id 的防护措施（如 OPRF/盐、签名、零知识证明、差分隐私等）。

---

## 9. 运行结果
两方在不泄露各自完整数据集的情况下，成功计算出了交集元素的权重和，并且结果与直接明文计算的结果一致：



